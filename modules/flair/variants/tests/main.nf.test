nextflow_process {

    name "Test Process FLAIR_VARIANTS"
    script "../main.nf"
    process "FLAIR_VARIANTS"

    tag "modules"
    tag "flair"
    tag "flair/variants"

    test("variants - basic") {

        when {
            process {
                """
                def test_data_dir = file("\${projectDir}/modules/flair/testdata", checkIfExists: true)
                
                def manifest = file("\${test_data_dir}/test_manifest.tsv", checkIfExists: true)
                def bam = file("\${test_data_dir}/test_transcriptome.bam", checkIfExists: true)
                def bai = file("\${test_data_dir}/test_transcriptome.bam.bai", checkIfExists: true)
                def vcf = file("\${test_data_dir}/test_genome.vcf", checkIfExists: true)
                def bed = file("\${test_data_dir}/test-collapse-annot.isoforms.bed", checkIfExists: true)
                def fa  = file("\${test_data_dir}/test_filtered_isoforms.fa", checkIfExists: true)
                def fai = file("\${test_data_dir}/test_filtered_isoforms.fa.fai", checkIfExists: true)
                def genome = file("\${test_data_dir}/genome.fa", checkIfExists: true)
                def genome_fai = file("\${test_data_dir}/genome.fa.fai", checkIfExists: true)
                def gtf = file("\${test_data_dir}/basic.annotation.gtf", checkIfExists: true)

                input[0] = [ 
                    [ id:'test' ], 
                    manifest, 
                    [bam, bai, vcf], 
                    bed, 
                    [fa, fai]
                ]
                input[1] = [ genome, genome_fai ]
                input[2] = gtf
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() },
                { assert path(process.out.variants[0][1]).exists() }
            )
        }
    }

    test("variants - stub") {

        options "-stub"

        when {
            process {
                """
                def test_data_dir = file("\${projectDir}/modules/flair/testdata", checkIfExists: true)
                
                def manifest = file("\${test_data_dir}/test_manifest.tsv", checkIfExists: true)
                // Stub inputs don't need to exist if we use file(..., checkIfExists: false) but here we have them
                def bam = file("\${test_data_dir}/test_transcriptome.bam", checkIfExists: true)
                def bai = file("\${test_data_dir}/test_transcriptome.bam.bai", checkIfExists: true)
                def vcf = file("\${test_data_dir}/test_genome.vcf", checkIfExists: true)
                def bed = file("\${test_data_dir}/test-collapse-annot.isoforms.bed", checkIfExists: true)
                def fa  = file("\${test_data_dir}/test_filtered_isoforms.fa", checkIfExists: true)
                def fai = file("\${test_data_dir}/test_filtered_isoforms.fa.fai", checkIfExists: true)
                def genome = file("\${test_data_dir}/genome.fa", checkIfExists: true)
                def genome_fai = file("\${test_data_dir}/genome.fa.fai", checkIfExists: true)
                def gtf = file("\${test_data_dir}/basic.annotation.gtf", checkIfExists: true)

                input[0] = [ 
                    [ id:'test' ], 
                    manifest, 
                    [bam, bai, vcf], 
                    bed, 
                    [fa, fai]
                ]
                input[1] = [ genome, genome_fai ]
                input[2] = gtf
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }
    }
}
